function initializePage(){function e(e){void 0!==App_.current_position_marker&&App_.map.removeLayer(App_.current_position_marker),void 0!==App_.current_position_circle&&App_.map.removeLayer(App_.current_position_circle);var i=e.accuracy/2;App_.current_position_marker=L.marker(e.latlng).addTo(App_.map).bindPopup("Tu estas en un radio de "+i+" metros desde este punto"),App_.current_position_circle=L.circle(e.latlng,i).addTo(App_.map),setTimeout(function(){App_.can_refresh_position=!0},1e3)}function i(e){ToastrUtility_.error(e.message)}App=new Vue({el:"#App",data:{map:void 0,map_markers:[],user:{name:"",email:""},operations:{deliveries:[],pickups:[]},deliveries_to_show:[],pickups_to_show:[],ajax_queue_count:0,current_position:void 0,current_position_marker:void 0,current_position_circle:void 0,dates_to_filter:[],date_to_filter:void 0,ready:!0,can_refresh_position:!1},methods:{synchronize_data_operations:function(e){var i=$(e.target);i.loading(),Operations.synchronize_data_operations({success:function(){i.unloading()},fail:function(){i.unloading()}})},check_ajax_queue:function(e){var i=$(e.target);AjaxQueue.check_queue_from_element(i)},remove_markers_in_map:function(){var e=this;$.each(e.map_markers,function(){e.map.removeLayer(this)})},new_icon:function(e){return L.icon({iconUrl:e,shadowUrl:"images/map_icons/marker-shadow.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],tooltipAnchor:[16,-28],shadowSize:[41,41]})},distance_to_pickup:function(e,i){var t=this,a=Haversine.distance_in_text(t.current_position,i);return a.success&&i.distance_in_mts!==a.distance_in_mts&&(i.distance_in_mts=a.distance_in_mts,PickupModel.update({id:i.id},i,{success:function(){t.operations.pickups=PickupModel.get()}})),a.message},distance_to_delivery:function(e,i){var t=this,a=Haversine.distance_in_text(t.current_position,i);return a.success&&i.distance_in_mts!==a.distance_in_mts&&(i.distance_in_mts=a.distance_in_mts,DeliveriesModel.update({id:i.id},i,{success:function(){t.operations.deliveries=DeliveriesModel.get()}})),a.message},centerLeafletMapOnMarker:function(e){var i=[e.getLatLng()],t=L.latLngBounds(i);App_.map.fitBounds(t)}},filters:{},watch:{"operations.deliveries":function(e,i){App_=this;var t=_(App.operations.pickups).chain().groupBy("pickup_date").keys().value(),a=_(App.operations.deliveries).chain().groupBy("delivery_date").keys().value();this.dates_to_filter=_.sortBy(_.union(t,a)),void 0===this.date_to_filter&&this.dates_to_filter.length>0&&(this.date_to_filter=this.dates_to_filter[0])},"operations.pickups":function(e,i){App_=this;var t=_(App.operations.pickups).chain().groupBy("pickup_date").keys().value(),a=_(App.operations.deliveries).chain().groupBy("delivery_date").keys().value();this.dates_to_filter=_.sortBy(_.union(t,a)),void 0===this.date_to_filter&&this.dates_to_filter.length>0&&(this.date_to_filter=this.dates_to_filter[0])},date_to_filter:function(e){var i=this;this.remove_markers_in_map(),this.deliveries_to_show=_.where(i.operations.deliveries,{delivery_date:e}),this.pickups_to_show=_.where(i.operations.pickups,{pickup_date:e})},pickups_to_show:function(e){var i=this,t=UrlUtility_.getParams();$.each(e,function(e,a){if(null!==a.longitude&&null!==a.latitude){var o=i.new_icon("images/map_icons/pickup_"+a.pickup_state["class"]+".png?1"),n=(new L.marker).setLatLng({lng:a.longitude,lat:a.latitude}).setIcon(o).addTo(i.map).bindPopup("<div style='text-align:center;'>Recolección <span class='label bg-"+a.pickup_state["class"]+"'>"+a.pickup_state.name+"</span></div><i class='fa fa-user'></i>"+a.courier.email+" - <b>"+a.pickup_number+"</b><br><b>Dirección: </b> "+a.address+" <br><b>Observaciones dirección: </b> "+a.long_address+"<br><i class='fa fa-clock-o'></i>"+a.pickup_start_time+" y "+a.pickup_end_time+" <br><i class='fa fa-globe'></i> A "+Haversine.mtrs_to_text(a.distance_in_mts)+"  <br><a class='btn btn-primary btn-block' style='color: white!important;' href='index.html?filter_date="+a.pickup_date+"&search="+a.pickup_number+"&tab=tab_pickups'> <i class='fa fa-external-link'></i> Ver </a><br><a class='a-popup-close-button btn btn-danger btn-block' style='color: white!important;' href='#close'> <i class='fa fa-times'></i> Ocultar </a><br>");void 0!==t.show_pickup_id&&t.show_pickup_id==a.id&&n.openPopup(),i.map_markers.push(n),void 0!==t.show_pickup_id&&t.show_pickup_id==a.id&&i.centerLeafletMapOnMarker(n)}})},deliveries_to_show:function(e){var i=this,t=UrlUtility_.getParams();$.each(e,function(e,a){if(null!==a.longitude&&null!==a.latitude){var o=i.new_icon("images/map_icons/delivery_"+a.delivery_state["class"]+".png?1"),n=(new L.marker).setLatLng({lng:a.longitude,lat:a.latitude}).setIcon(o).addTo(i.map).bindPopup("<div style='text-align:center;'>Entrega <span class='label bg-"+a.delivery_state["class"]+"'>"+a.delivery_state.name+"</span></div><i class='fa fa-user'></i>"+a.courier.email+" - <b>"+a.delivery_number+"</b><br><b>Dirección: </b> "+a.address+" <br><b>Observaciones dirección: </b> "+a.long_address+"<br><i class='fa fa-clock-o'></i>"+a.delivery_start_time+" y "+a.delivery_end_time+" <br><i class='fa fa-globe'></i> A "+Haversine.mtrs_to_text(a.distance_in_mts)+"  <br><a class='btn btn-primary btn-block' style='color: white!important;' href='index.html?filter_date="+a.delivery_date+"&search="+a.delivery_number+"&tab=tab_deliveries'> <i class='fa fa-external-link'></i> Ver </a><br><a class='a-popup-close-button btn btn-danger btn-block' style='color: white!important;' href='#close'> <i class='fa fa-times'></i> Ocultar </a><br>");void 0!==t.show_delivery_id&&t.show_delivery_id==a.id&&n.openPopup(),i.map_markers.push(n),void 0!==t.show_delivery_id&&t.show_delivery_id==a.id&&i.centerLeafletMapOnMarker(n)}})},current_position:function(e){this.can_refresh_position&&App_.map.locate({maxZoom:12})}},mounted:function(){App_=this;UrlUtility_.getParams();App_.map=L.map("map").fitWorld(),L.tileLayer("http://{s}.tile.osm.org/{z}/{x}/{y}.png",{attribution:'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="http://mapbox.com">Mapbox</a>',maxZoom:18}).addTo(App_.map),App_.map.locate({setView:!0,maxZoom:14}),App_.map.on("locationfound",e),App_.map.on("locationerror",i),GpsModel.loaded(function(){App_.current_position=GpsModel.get()}),UserModel.loaded(function(){var e=UserModel.get();null!==e&&(App_.user.email=e.user_data.email,App_.user.name=e.user_data.name)}),Ajax_queueModel.loaded(function(){App_.ajax_queue_count=Ajax_queueModel.get().length}),DeliveriesModel.loaded(function(){App_.operations.deliveries=DeliveriesModel.get(),PickupModel.loaded(function(){App_.operations.pickups=PickupModel.get()})})}}),$(document).ready(function(){$(document).on("click",".a-popup-close-button",function(){App.map.closePopup()})})}var App;