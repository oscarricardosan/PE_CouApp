function initializePage(){function e(){cordova.plugins.diagnostic.isBluetoothAvailable(function(e){e&&scanBluetoohtDevices()})}App=new Vue({el:"#App",data:{user:{name:"",email:""},operations:{deliveries:[],pickups:[],current_pickup:{},current_delivery:{}},bluetooth_devices:[],printer_device:null,current_photo:"images/camera.png",ajax_queue_count:0,settings_current_printer:null,dates_to_filter:[],date_to_filter:void 0,number_search:"",pickups_in_list:0,deliveries_in_list:0,current_position:void 0,ready:!0},methods:{synchronize_data_operations:function(e){var i=$(e.target);i.loading(),Operations.synchronize_data_operations({success:function(){i.unloading()},fail:function(){alert("Error al sincronizar"),i.unloading()}})},showPickupModal:function(e){this.operations.current_delivery={},this.operations.current_pickup=e,$("#pickup_action_modal").modal("show")},showDeliveryModal:function(e){this.operations.current_pickup={},this.operations.current_delivery=e,$("#delivery_action_modal").modal("show")},check_ajax_queue:function(e){var i=$(e.target);AjaxQueue.check_queue_from_element(i)},contains:function(e,i){return"object"==typeof i&&(i=JSON.stringify(i)),i.toUpperCase().indexOf(e.toUpperCase())>=0},refresh_counters_in_list:function(){App_=this,setTimeout(function(){var e=$(".list-group.pickups>.pickup").length,i=$(".list-group.deliveries>.delivery").length;App_.pickups_in_list=e,App_.deliveries_in_list=i,0==i&&e>0&&$('[href="#tab_pickups"]').click(),0==e&&i>0&&$('[href="#tab_deliveries"]').click()},200),setTimeout(function(){App_.pickups_in_list=$(".list-group.pickups>.pickup").length,App_.deliveries_in_list=$(".list-group.deliveries>.delivery").length},500)},pickups_sorted:function(){App_=this;var e=[],i=_(App_.operations.pickups).chain().where({pickup_date:App_.date_to_filter}).groupBy("pickup_state_id").keys().value();return $.each(i,function(i,t){var a=_(App_.operations.pickups).chain().where({pickup_state_id:1*t,pickup_date:App_.date_to_filter}).sortBy("distance_in_mts").value();e=_.union(e,a)}),e},deliveries_sorted:function(){App_=this;var e=[],i=_(App_.operations.deliveries).chain().where({delivery_date:App_.date_to_filter}).groupBy("delivery_state_id").keys().value();return $.each(i,function(i,t){var a=_(App_.operations.deliveries).chain().where({delivery_state_id:1*t,delivery_date:App_.date_to_filter}).sortBy("distance_in_mts").value();e=_.union(e,a)}),e},set_number_search:function(e){this.number_search=e}},filters:{formatMoney:function(e){return accounting.formatMoney(e)},formatNumber:function(e){return accounting.formatNumber(e)},distance_to_pickup:function(e,i){return distance=Haversine.distance_in_text(e,i),distance.success&&i.distance_in_mts!==distance.distance_in_mts&&(i.distance_in_mts=distance.distance_in_mts,PickupModel.update({id:i.id},i,{success:function(){App.operations.pickups=PickupModel.get()}})),distance.message},distance_to_delivery:function(e,i){return distance=Haversine.distance_in_text(e,i),distance.success&&i.distance_in_mts!==distance.distance_in_mts&&(i.distance_in_mts=distance.distance_in_mts,DeliveriesModel.update({id:i.id},i,{success:function(){App.operations.deliveries=DeliveriesModel.get()}})),distance.message}},watch:{"operations.deliveries":function(e,i){App_=this;var t=_(App.operations.pickups).chain().groupBy("pickup_date").keys().value(),a=_(App.operations.deliveries).chain().groupBy("delivery_date").keys().value();this.dates_to_filter=_.sortBy(_.union(t,a)),void 0===this.date_to_filter&&this.dates_to_filter.length>0&&(this.date_to_filter=this.dates_to_filter[0]),this.refresh_counters_in_list()},"operations.pickups":function(e,i){App_=this;var t=_(App.operations.pickups).chain().groupBy("pickup_date").keys().value(),a=_(App.operations.deliveries).chain().groupBy("delivery_date").keys().value();this.dates_to_filter=_.sortBy(_.union(t,a)),void 0===this.date_to_filter&&this.dates_to_filter.length>0&&(this.date_to_filter=this.dates_to_filter[0]),this.refresh_counters_in_list()},date_to_filter:function(){this.refresh_counters_in_list()},number_search:function(){this.refresh_counters_in_list()}},mounted:function(){accounting.settings={currency:{symbol:"$",format:"%s%v",decimal:",",thousand:".",precision:2},number:{precision:0,thousand:".",decimal:","}},App_=this,UserModel.loaded(function(){var e=UserModel.get();null!==e&&(App_.user.email=e.user_data.email,App_.user.name=e.user_data.name)}),DeliveriesModel.loaded(function(){App_.operations.deliveries=DeliveriesModel.get()}),PickupModel.loaded(function(){App_.operations.pickups=PickupModel.get()}),Ajax_queueModel.loaded(function(){App_.ajax_queue_count=Ajax_queueModel.get().length}),PrinterModel.loaded(function(){var e=PrinterModel.get();null!==e&&(App_.settings_current_printer=e.address)}),GpsModel.loaded(function(){App_.current_position=GpsModel.get()});var e=UrlUtility_.getParams();void 0!==e.filter_date&&(this.date_to_filter=e.filter_date),void 0!==e.search&&(this.number_search=e.search)}}),$(document).ready(function(){function e(e,i){try{i=PolishedUtility_.callback(i),window.DatecsPrinter.connect(e,function(){i.success(),PrinterModel.store({address:e})},function(e){alert("Error al conectar con impresora: "+JSON.stringify(e)),i.fail()})}catch(t){alert("Error al conectar con impresora_: "+JSON.stringify(t))}}var i=UrlUtility_.getParams();void 0!==i.tab&&$('[href="#'+i.tab+'"]').click(),$("#scan_barcode_to_search").click(function(){cloudSky.zBar.scan({text_title:"Leer código de barras",text_instructions:"Por favor apuntar tu camara al código de barras"},function(e){App.number_search=e},function(){})}),$(".scan_barcode_update_consigment").click(function(){var e=$(this);cloudSky.zBar.scan({text_title:"Leer código de barras",text_instructions:"Por favor apuntar tu camara al código de barras"},function(i){var t=e.closest("form").find('[name="guias"]');""!=$.trim(t.val())&&t.val(t.val()+"\n"),t.val(t.val()+i+"\n")},function(){})}),$(".takePhoto").click(function(e){function i(e){App.current_photo="data:image/png;base64,"+e}function t(e){alert("Failed because: "+e)}e.preventDefault(),navigator.camera.getPicture(i,t,{quality:50,destinationType:Camera.DestinationType.DATA_URL,sourceType:Camera.PictureSourceType.CAMERA,encodingType:Camera.EncodingType.PNG,targetHeight:700,targetWidth:700})}),$(".selectPhoto").click(function(e){function i(e){App.current_photo="data:image/png;base64,"+e}function t(e){alert("Failed because: "+e)}e.preventDefault(),navigator.camera.getPicture(i,t,{quality:50,destinationType:Camera.DestinationType.DATA_URL,sourceType:Camera.PictureSourceType.SAVEDPHOTOALBUM,encodingType:Camera.EncodingType.PNG,targetHeight:700,targetWidth:700})}),$("#delivery_attach_photo, #pickup_attach_photo").on("hidden.bs.modal",function(){App.current_photo="images/camera.png",$(this).find("[name]").val("")}),$(".attach_photo_to_delivery").click(function(){if("images/camera.png"===App.current_photo)return alert("Debes cargar una foto"),!1;var e=$(this).closest(".modal");e.loading();var i=FormUtility_.serialized_data_to_json(e.find("form").serializeArray());i.data_uri_photo=App.current_photo,i.entrega_id=App.operations.current_delivery.id,AjaxQueue.add({process_name:"Adjunto foto delivery: ",type:"post",url:"delivery/attach_photo",dataType:"json",data:i,success:function(i){!cordova.plugins.backgroundMode.isActive()&&$("#delivery_attach_photo").is(":visible")&&(ToastrUtility_.success(i.message),$("#delivery_attach_photo").modal("hide")),"object"==typeof e&&e.unloading()},fail:function(){!cordova.plugins.backgroundMode.isActive()&&$("#delivery_attach_photo").is(":visible")&&(ToastrUtility_.warning("Sin conexion a servidor, se transmitira más tarde."),$("#delivery_attach_photo").modal("hide")),"object"==typeof e&&e.unloading()}})}),$(".attach_photo_to_pickup").click(function(){if("images/camera.png"===App.current_photo)return alert("Debes cargar una foto"),!1;var e=$(this).closest(".modal");e.loading();var i=FormUtility_.serialized_data_to_json(e.find("form").serializeArray());i.data_uri_photo=App.current_photo,i.recoleccion_id=App.operations.current_pickup.id,AjaxQueue.add({process_name:"Adjunto foto pickup: ",type:"post",url:"pickup/attach_photo",dataType:"json",data:i,success:function(i){!cordova.plugins.backgroundMode.isActive()&&$("#pickup_attach_photo").is(":visible")&&(ToastrUtility_.success(i.message),$("#pickup_attach_photo").modal("hide")),"object"==typeof e&&e.unloading()},fail:function(){!cordova.plugins.backgroundMode.isActive()&&$("#pickup_attach_photo").is(":visible")&&(ToastrUtility_.warning("Sin conexion a servidor, se transmitira más tarde."),$("#pickup_attach_photo").modal("hide")),"object"==typeof e&&e.unloading()}})}),$("#pickup_exception_modal, #delivery_exception_modal").on("show.bs.modal",function(){$(this).find("[name]").val(""),$(this).find("[current_time]").val(MomentUtility_.current_time().substr(0,5)),$(this).find("[current_date]").val(MomentUtility_.current_date())}),$("#pickup_exception_modal form").submit(function(e){e.preventDefault();var i=$(this);i.loading(),data=FormUtility_.serialized_data_to_json(i.serializeArray()),data.recoleccion_id=App.operations.current_pickup.id,AjaxQueue.add({process_name:"Pickup guardar excepción: ",type:"post",url:"pickup/store_exception",dataType:"json",data:data,success:function(e){cordova.plugins.backgroundMode.isActive()?PickupModel.update({id:e.data.id},e.data,{success:function(){App.operations.current_pickup=e.data,App.operations.pickups=PickupModel.get()}}):("object"==typeof i&&i.unloading(),PickupModel.update({id:e.data.id},e.data,{success:function(){App.operations.current_pickup=e.data,App.operations.pickups=PickupModel.get(),$("#pickup_exception_modal").is(":visible")&&(ToastrUtility_.success(e.message),$("#pickup_exception_modal").modal("hide"))}}))},fail:function(){App.operations.current_pickup.pickup_state={name:"Excepción","class":"red",can_edit:!1,can_cancel:!1},App.operations.current_pickup.pickup_state_id=300,cordova.plugins.backgroundMode.isActive()?PickupModel.update({id:App.operations.current_pickup.id},App.operations.current_pickup,{success:function(){App.operations.pickups=PickupModel.get()}}):($("#pickup_exception_modal").is(":visible")&&ToastrUtility_.warning("Sin conexion a servidor, se transmitira más tarde."),"object"==typeof i&&i.unloading(),PickupModel.update({id:App.operations.current_pickup.id},App.operations.current_pickup,{success:function(){$("#pickup_exception_modal").is(":visible")&&$("#pickup_exception_modal").modal("hide"),App.operations.pickups=PickupModel.get()}}))}})}),$("#delivery_exception_modal form").submit(function(e){e.preventDefault();var i=$(this);i.loading(),data=FormUtility_.serialized_data_to_json(i.serializeArray()),data.entrega_id=App.operations.current_delivery.id,AjaxQueue.add({process_name:"Delivery guardar excepción: ",type:"post",url:"delivery/store_exception",dataType:"json",data:data,success:function(e){cordova.plugins.backgroundMode.isActive()?DeliveriesModel.update({id:e.data.id},e.data,{success:function(){App.operations.current_delivery=e.data,App.operations.deliveries=DeliveriesModel.get()}}):("object"==typeof i&&i.unloading(),DeliveriesModel.update({id:e.data.id},e.data,{success:function(){App.operations.current_delivery=e.data,App.operations.deliveries=DeliveriesModel.get(),$("#delivery_exception_modal").is(":visible")&&(ToastrUtility_.success(e.message),$("#delivery_exception_modal").modal("hide"))}}))},fail:function(e,t){App.operations.current_delivery.delivery_state={name:"Excepción","class":"red",can_edit:!1,can_cancel:!1},App.operations.current_delivery.delivery_state_id=300,cordova.plugins.backgroundMode.isActive()?DeliveriesModel.update({id:App.operations.current_delivery.id},App.operations.current_delivery,{success:function(){App.operations.deliveries=DeliveriesModel.get()}}):($("#delivery_exception_modal").is(":visible")&&ToastrUtility_.warning("Sin conexion a servidor, se transmitira más tarde."),"object"==typeof i&&i.unloading(),DeliveriesModel.update({id:App.operations.current_delivery.id},App.operations.current_delivery,{success:function(){$("#delivery_exception_modal").is(":visible")&&$("#delivery_exception_modal").modal("hide"),App.operations.deliveries=DeliveriesModel.get()}}))}})}),$("#delivery_success_modal, #pickup_success_modal").on("show.bs.modal",function(){$(this).find("[name]:not([default-value])").val(""),$(this).find("[default-value]").each(function(){$(this).val($(this).attr("default-value"))}),$(this).find("[current_time]").val(MomentUtility_.current_time().substr(0,5)),$(this).find("[current_date]").val(MomentUtility_.current_date())}),$("#pickup_success_modal form").submit(function(e){e.preventDefault();var i=$(this);i.loading(),data=FormUtility_.serialized_data_to_json(i.serializeArray()),data.recoleccion_id=App.operations.current_pickup.id,AjaxQueue.add({process_name:"Pickup exitoso: ",type:"post",url:"pickup/store_successful",dataType:"json",data:data,success:function(e){cordova.plugins.backgroundMode.isActive()?PickupModel.update({id:e.data.id},e.data,{success:function(){App.operations.current_pickup=e.data,App.operations.pickups=PickupModel.get()}}):("object"==typeof i&&i.unloading(),PickupModel.update({id:e.data.id},e.data,{success:function(){App.operations.current_pickup=e.data,App.operations.pickups=PickupModel.get(),$("#pickup_success_modal").is(":visible")&&(ToastrUtility_.success(e.message),$("#pickup_success_modal").modal("hide"))}}))},fail:function(e,t){App.operations.current_pickup.pickup_state={name:"Realizada","class":"green",can_edit:!1,can_cancel:!1},App.operations.current_pickup.pickup_state_id=200,cordova.plugins.backgroundMode.isActive()?PickupModel.update({id:App.operations.current_pickup.id},App.operations.current_pickup,{success:function(){App.operations.pickups=PickupModel.get()}}):($("#pickup_success_modal").is(":visible")&&ToastrUtility_.warning("Sin conexion a servidor, se transmitira más tarde."),"object"==typeof i&&i.unloading(),PickupModel.update({id:App.operations.current_pickup.id},App.operations.current_pickup,{success:function(){App.operations.pickups=PickupModel.get(),$("#pickup_success_modal").is(":visible")&&$("#pickup_success_modal").modal("hide")}}))}})}),$("#delivery_success_modal form").submit(function(e){e.preventDefault();var i=$(this);i.loading(),data=FormUtility_.serialized_data_to_json(i.serializeArray()),data.entrega_id=App.operations.current_delivery.id,AjaxQueue.add({process_name:"Delivery exitoso: ",type:"post",url:"delivery/store_successful",dataType:"json",data:data,success:function(e){cordova.plugins.backgroundMode.isActive()?DeliveriesModel.update({id:e.data.id},e.data,{success:function(){App.operations.current_delivery=e.data,App.operations.deliveries=DeliveriesModel.get()}}):("object"==typeof i&&i.unloading(),DeliveriesModel.update({id:e.data.id},e.data,{success:function(){App.operations.current_delivery=e.data,App.operations.deliveries=DeliveriesModel.get(),$("#delivery_success_modal").is(":visible")&&(ToastrUtility_.success(e.message),$("#delivery_success_modal").modal("hide"))}}))},fail:function(){App.operations.current_delivery.delivery_state={name:"Realizada","class":"green",can_edit:!1,can_cancel:!1},App.operations.current_delivery.delivery_state_id=200,cordova.plugins.backgroundMode.isActive()?DeliveriesModel.update({id:App.operations.current_delivery.id},App.operations.current_delivery,{success:function(){App.operations.deliveries=DeliveriesModel.get()}}):("object"==typeof i&&i.unloading(),$("#delivery_success_modal").is(":visible")&&ToastrUtility_.warning("Sin conexion a servidor, se transmitira más tarde."),DeliveriesModel.update({id:App.operations.current_delivery.id},App.operations.current_delivery,{success:function(){$("#delivery_success_modal").is(":visible")&&$("#delivery_success_modal").modal("hide"),App.operations.deliveries=DeliveriesModel.get()}}))}})}),$("#pickup_consignments_modal").on("show.bs.modal",function(){$('#pickup_consignments_modal [name="guias"]').val(App.operations.current_pickup.consignments.join("\n"))}),$("#delivery_consignments_modal").on("show.bs.modal",function(){$('#delivery_consignments_modal [name="guias"]').val(App.operations.current_delivery.consignments.join("\n"))}),$("#pickup_consignments_modal form").submit(function(e){e.preventDefault();var i=$(this);return data=FormUtility_.serialized_data_to_json(i.serializeArray()),data.recoleccion_id=App.operations.current_pickup.id,""==$.trim(data.guias)?(alert("Campo guías es obligatorio"),!1):(i.loading(),void AjaxQueue.add({process_name:"Pickup asociación guías: ",type:"post",url:"pickup/update_consignments",dataType:"json",data:data,success:function(e){cordova.plugins.backgroundMode.isActive()?PickupModel.update({id:e.data.id},e.data,{success:function(){App.operations.current_pickup=e.data,App.operations.pickups=PickupModel.get()}}):("object"==typeof i&&i.unloading(),PickupModel.update({id:e.data.id},e.data,{success:function(){App.operations.current_pickup=e.data,App.operations.pickups=PickupModel.get(),$("#pickup_consignments_modal").is(":visible")&&(ToastrUtility_.success(e.message),$("#pickup_consignments_modal").modal("hide"))}}))},fail:function(e,t){App.operations.current_pickup.consignments=data.guias.split("\n"),cordova.plugins.backgroundMode.isActive()?PickupModel.update({id:App.operations.current_pickup.id},App.operations.current_pickup,{success:function(){App.operations.pickups=PickupModel.get()}}):($("#pickup_consignments_modal").is(":visible")&&ToastrUtility_.warning("Sin conexion a servidor, se transmitira más tarde."),"object"==typeof i&&i.unloading(),PickupModel.update({id:App.operations.current_pickup.id},App.operations.current_pickup,{success:function(){App.operations.pickups=PickupModel.get(),$("#pickup_consignments_modal").is(":visible")&&$("#pickup_consignments_modal").modal("hide")}}))}}))}),$("#delivery_consignments_modal form").submit(function(e){e.preventDefault();var i=$(this);return data=FormUtility_.serialized_data_to_json(i.serializeArray()),data.entrega_id=App.operations.current_delivery.id,""==$.trim(data.guias)?(alert("Campo guías es obligatorio"),!1):(i.loading(),void AjaxQueue.add({process_name:"Delivery asociación guías: ",type:"post",url:"delivery/update_consignments",dataType:"json",data:data,success:function(e){cordova.plugins.backgroundMode.isActive()?DeliveriesModel.update({id:e.data.id},e.data,{success:function(){App.operations.current_delivery=e.data,App.operations.deliveries=DeliveriesModel.get()}}):("object"==typeof i&&i.unloading(),DeliveriesModel.update({id:e.data.id},e.data,{success:function(){App.operations.current_delivery=e.data,App.operations.deliveries=DeliveriesModel.get(),$("#delivery_consignments_modal").is(":visible")&&(ToastrUtility_.success(e.message),$("#delivery_consignments_modal").modal("hide"))}}))},fail:function(){App.operations.current_delivery.consignments=data.guias.split("\n"),cordova.plugins.backgroundMode.isActive()?DeliveriesModel.update({id:App.operations.current_delivery.id},App.operations.current_delivery,{success:function(){App.operations.deliveries=DeliveriesModel.get()}}):("object"==typeof i&&i.unloading(),$("#delivery_consignments_modal").is(":visible")&&ToastrUtility_.warning("Sin conexion a servidor, se transmitira más tarde."),DeliveriesModel.update({id:App.operations.current_delivery.id},App.operations.current_delivery,{success:function(){$("#delivery_consignments_modal").is(":visible")&&$("#delivery_consignments_modal").modal("hide"),App.operations.deliveries=DeliveriesModel.get()}}))}}))}),$("#print_pickup_label form").submit(function(i){i.preventDefault();try{var t=$(this).find(".type_print").val();e(App.settings_current_printer,{success:function(){PrinterFormat.pickup_label(t),$("#print_pickup_label").modal("hide")}})}catch(a){alert("Error al imprimir "+JSON.stringify(a))}}),$("#print_delivery_label form").submit(function(i){i.preventDefault();try{var t=$(this).find(".type_print").val();e(App.settings_current_printer,{success:function(){PrinterFormat.delivery_label(t),$("#print_delivery_label").modal("hide")}})}catch(a){alert("Error al imprimir "+JSON.stringify(a))}})}),document.addEventListener("deviceready",e,!1)}function scanBluetoohtDevices(){window.DatecsPrinter.listBluetoothDevices(function(e){App.bluetooth_devices=e},function(e){alert("Error: "+JSON.stringify(e))})}function printText(){window.DatecsPrinter.feedPaper(1);var e=prompt("Texto a imprimir");window.DatecsPrinter.printText(e,"ISO-8859-1"),window.DatecsPrinter.feedPaper(1)}var App;